# TODO 리스트 - 251206

## 요구사항 분석
1. API 설정의 Perplexity API 키와 모델(선택) 입력 UI 제거
2. API 키와 모델은 서버의 설정 파일(환경변수)로 관리
3. 카카오 로그인 연동 기능 구현

---

## 작업 리스트

### Phase 1: API 키 서버 이전

#### 1-1. 백엔드 환경변수 설정
- [x] **파일**: `smart-investor-backend/.env`
  - [x] `PERPLEXITY_API_KEY` 추가
  - [x] `PERPLEXITY_DEFAULT_MODEL` 추가 (기본값: sonar-deep-research)
  
#### 1-2. 백엔드 API 수정
- [x] **파일**: `smart-investor-backend/app/services/perplexity_service.py`
  - [x] 환경변수에서 API 키 읽도록 수정
  - [x] `__init__` 메서드에서 api_key 파라미터를 선택적으로 변경
  - [x] 환경변수 `PERPLEXITY_API_KEY` 우선 사용

- [x] **파일**: `smart-investor-backend/app/api/analysis.py`
  - [x] 요청 body에서 `api_key` 제거
  - [x] 환경변수에서 API 키 읽어서 PerplexityService에 전달
  - [x] model도 환경변수 기본값 사용하도록 수정

- [x] **파일**: `smart-investor-backend/app/models/analysis.py`
  - [x] `AnalysisRequest` 모델에서 `api_key` 필드 제거
  - [x] `model` 필드를 Optional로 유지 (환경변수 기본값 사용)

#### 1-3. 프론트엔드 UI 제거
- [x] **파일**: `src/app/analyze/page.tsx`
  - [x] formData state에서 `apiKey`, `model` 필드 제거
  - [x] API 설정 섹션 UI 전체 제거 (line 422-455)
  - [x] API 호출 시 `api_key` 파라미터 제거
  - [x] model 쿼리 파라미터 제거 (백엔드에서 환경변수 사용)

---

### Phase 2: 카카오 로그인 연동

#### 2-1. 카카오 개발자 앱 설정
- [ ] 카카오 개발자 콘솔(https://developers.kakao.com) 접속
- [ ] 새 애플리케이션 생성 또는 기존 앱 사용
- [ ] 플랫폼 설정:
  - [ ] Web 플랫폼 추가
  - [ ] 사이트 도메인: `http://localhost:3000` 추가
- [ ] Kakao Login 활성화:
  - [ ] 제품 설정 > 카카오 로그인 활성화
  - [ ] Redirect URI 설정: `http://localhost:3000/api/auth/callback/kakao`
  - [ ] 동의 항목 설정: 이메일(필수), 닉네임(선택), 프로필 이미지(선택)
- [ ] REST API 키, Client Secret 발급
- [x] **참고 가이드**: `doc/kakao-oauth-setup-guide.md` 생성 완료

#### 2-2. 프론트엔드 환경변수 설정
- [ ] **파일**: `.env.development`
  - [ ] `KAKAO_CLIENT_ID` 값을 실제 REST API 키로 변경
  - [ ] `KAKAO_CLIENT_SECRET` 값을 실제 Client Secret으로 변경

#### 2-3. OAuth 프로바이더 활성화
- [x] **파일**: `src/auth.ts`
  - [x] 이미 KakaoProvider가 조건부로 추가되어 있음 확인
  - [x] 환경변수가 올바르게 설정되면 자동으로 활성화됨
  - [x] 디버그 로그 추가하여 Kakao Provider 활성화 확인

#### 2-4. 로그인 UI 업데이트
- [ ] **파일**: `src/components/AuthHeader.tsx` (또는 로그인 페이지)
  - [ ] Kakao 로그인 버튼 UI 확인
  - [ ] Kakao 브랜드 컬러(#FEE500, 검정 텍스트) 적용
  - [ ] Kakao 로고 아이콘 추가 (선택)

#### 2-5. Supabase Users 테이블 확인
- [ ] **파일**: `src/lib/supabase/users.ts`
  - [ ] `upsertUser` 함수가 Kakao provider 지원하는지 확인
  - [ ] provider_id 형식: `kakao:{providerAccountId}` 확인

---

### Phase 3: 테스트 및 검증

#### 3-1. 백엔드 API 키 테스트
- [ ] 백엔드 서버 재시작 후 환경변수 로드 확인
- [ ] `/api/analysis/analyze` 엔드포인트 테스트
- [ ] API 키 없이도 요청 성공하는지 확인
- [ ] 잘못된 API 키 설정 시 에러 핸들링 확인

#### 3-2. 프론트엔드 UI 테스트
- [ ] 분석 페이지에서 API 설정 섹션이 보이지 않는지 확인
- [ ] 주식 정보 입력 후 분석 요청 정상 동작 확인
- [ ] 에러 메시지 정상 표시되는지 확인

#### 3-3. 카카오 로그인 테스트
- [ ] Kakao 로그인 버튼 클릭 시 Kakao 로그인 페이지로 이동 확인
- [ ] 로그인 후 Callback URL로 정상 리디렉션 확인
- [ ] 세션에 사용자 정보(이메일, 이름) 정상 저장 확인
- [ ] Supabase users 테이블에 Kakao 사용자 정보 저장 확인
- [ ] 로그아웃 후 재로그인 시 기존 계정 매칭 확인

#### 3-4. 통합 테스트
- [ ] Kakao로 로그인 후 분석 기능 사용 확인
- [ ] 분석 이력이 해당 사용자에게 정상 저장되는지 확인
- [ ] Profile 페이지에서 분석 이력 표시 확인

---

## 우선순위

### Priority 1 (즉시 작업)
1. 백엔드 환경변수 설정 (1-1)
2. 백엔드 API 수정 (1-2)
3. 프론트엔드 UI 제거 (1-3)

### Priority 2 (카카오 로그인)
4. 카카오 개발자 앱 설정 (2-1)
5. 프론트엔드 환경변수 설정 (2-2)
6. 로그인 UI 확인 (2-4)

### Priority 3 (검증)
7. 백엔드 API 키 테스트 (3-1)
8. 프론트엔드 UI 테스트 (3-2)
9. 카카오 로그인 테스트 (3-3)
10. 통합 테스트 (3-4)

---

## 주의사항

### API 키 보안
- API 키는 절대 프론트엔드에 노출되면 안 됨
- .env 파일은 .gitignore에 포함되어 있는지 확인
- 프로덕션 환경에서는 환경변수 관리 시스템 사용 권장

### Kakao OAuth 설정
- Redirect URI는 정확히 일치해야 함 (후행 슬래시 주의)
- 동의 항목에서 이메일은 필수로 설정
- 앱 심사 전에는 테스터 등록한 카카오 계정으로만 테스트 가능

### 호환성
- 기존 Naver 로그인과 동시에 사용 가능
- NextAuth는 여러 provider 동시 지원
- 사용자는 Naver 또는 Kakao 중 선택하여 로그인

---

## 예상 소요 시간
- Phase 1 (API 키 서버 이전): 1-2시간
- Phase 2 (카카오 로그인): 2-3시간
- Phase 3 (테스트): 1-2시간
- **총 예상 시간**: 4-7시간

---

## 완료 후 확인사항
- [ ] 프론트엔드에서 API 키 입력 UI 완전히 제거됨
- [ ] 백엔드 환경변수에서 API 키 정상 로드됨
- [ ] 분석 기능이 정상 동작함
- [ ] Kakao 로그인이 정상 동작함
- [ ] Kakao 로그인한 사용자의 분석 이력이 정상 저장됨
- [x] 문서 업데이트 (환경변수 설정 가이드)

---

## 추가 생성된 문서
- [x] `doc/kakao-oauth-setup-guide.md`: 카카오 로그인 상세 설정 가이드
- [x] `doc/implementation-summary-251206.md`: 구현 완료 요약 및 테스트 가이드
- [x] `smart-investor-backend/.env.example`: 백엔드 환경변수 예시 파일
- [x] `smart-investor-backend/docs/env-backend.example.md`: 업데이트됨 (Perplexity API 가이드 추가)
