# TODO List - 2025년 10월 23일

## 📋 요구사항 요약
1. 분석 중 로딩 인디케이터 및 시간 안내 메시지 추가
2. 사용자 정보 테이블에 분석가능 횟수 및 플랜 컬럼 추가
3. 우측 상단에 '내정보' 버튼 추가
4. '내정보' 페이지 구현 (이메일, 분석가능횟수, 플랜 표시)

---

## 🎯 Phase 1: 분석 중 로딩 UI 개선

### 1.1 로딩 인디케이터 컴포넌트 추가
- [x] `src/app/analyze/page.tsx` 수정
  - 분석 중 상태일 때 로딩 스피너 표시
  - "분석 중입니다. 최대 3분 소요될 수 있습니다." 메시지 추가
  - 로딩 애니메이션 효과 추가
  
  ```tsx
  {isLoading && (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl text-center">
        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <h3 className="text-xl font-semibold mb-2">분석 중입니다</h3>
        <p className="text-gray-600">최대 3분 소요될 수 있습니다.</p>
      </div>
    </div>
  )}
  ```

---

## 🎯 Phase 2: 사용자 정보 테이블 스키마 확장

### 2.1 Supabase 데이터베이스 스키마 수정
- [ ] **users 테이블에 컬럼 추가**
  ```sql
  -- users 테이블에 새로운 컬럼 추가
  ALTER TABLE users 
  ADD COLUMN IF NOT EXISTS analysis_count INTEGER DEFAULT 10,
  ADD COLUMN IF NOT EXISTS plan VARCHAR(20) DEFAULT 'free' CHECK (plan IN ('free', 'paid'));
  
  -- 컬럼 인덱스 추가
  CREATE INDEX IF NOT EXISTS idx_users_plan ON users(plan);
  
  -- 컬럼 코멘트 추가
  COMMENT ON COLUMN users.analysis_count IS '남은 분석 가능 횟수';
  COMMENT ON COLUMN users.plan IS '사용자 플랜 (free: 무료, paid: 유료)';
  ```

### 2.2 TypeScript 타입 업데이트
- [ ] `src/lib/supabase/users.ts` 수정
  - User 인터페이스에 `analysis_count`, `plan` 필드 추가
  
  ```typescript
  export interface User {
    id?: string;
    email: string;
    provider: string;
    provider_account_id: string;
    name?: string;
    analysis_count?: number; // 추가
    plan?: 'free' | 'paid';   // 추가
    created_at?: string;
    updated_at?: string;
    last_login_at?: string;
  }
  ```

### 2.3 사용자 생성 시 기본값 설정
- [ ] `src/lib/supabase/users.ts` - `upsertUser()` 함수 수정
  - 신규 사용자 생성 시 `analysis_count: 10`, `plan: 'free'` 기본값 설정

### 2.4 분석 횟수 차감 로직 추가
- [ ] `src/lib/supabase/users.ts`에 새로운 함수 추가
  - `decrementAnalysisCount(email)` - 분석 횟수 1 차감
  - `getAnalysisCount(email)` - 남은 분석 횟수 조회
  
  ```typescript
  /**
   * 분석 횟수 차감
   */
  export async function decrementAnalysisCount(email: string) {
    const supabase = getServerSupabase();
    
    const { data, error } = await supabase
      .from('users')
      .update({ 
        analysis_count: supabase.raw('analysis_count - 1'),
        updated_at: new Date().toISOString()
      })
      .eq('email', email)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  }
  ```

### 2.5 분석 실행 전 횟수 체크
- [ ] `src/app/analyze/page.tsx` 수정
  - `handleSubmit()` 함수에서 분석 실행 전 `analysis_count` 확인
  - 횟수가 0이면 "분석 가능 횟수를 모두 사용했습니다" 에러 표시
  - 분석 성공 시 횟수 차감 API 호출

---

## 🎯 Phase 3: '내정보' 버튼 추가

### 3.1 AuthHeader 컴포넌트 수정
- [ ] `src/components/AuthHeader.tsx` 수정
  - 로그인 상태일 때 '내정보' 버튼 추가
  - '내정보' 버튼 클릭 시 `/profile` 페이지로 이동
  
  ```tsx
  {session && (
    <>
      <Link href="/profile">
        <Button variant="outline">내정보</Button>
      </Link>
      <Button onClick={() => signOut()}>로그아웃</Button>
    </>
  )}
  ```

---

## 🎯 Phase 4: '내정보' 페이지 구현

### 4.1 프로필 페이지 생성
- [ ] `src/app/profile/page.tsx` 생성
  - 로그인 확인 (미로그인 시 홈으로 리다이렉트)
  - 사용자 정보 API 호출
  - 이메일, 분석가능횟수, 플랜 표시
  
  ```tsx
  'use client';
  
  import { useSession } from 'next-auth/react';
  import { useEffect, useState } from 'react';
  import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
  import { useRouter } from 'next/navigation';
  
  export default function ProfilePage() {
    const { data: session, status } = useSession();
    const router = useRouter();
    const [userInfo, setUserInfo] = useState(null);
    const [loading, setLoading] = useState(true);
    
    useEffect(() => {
      if (status === 'unauthenticated') {
        router.push('/');
      }
    }, [status, router]);
    
    useEffect(() => {
      if (session?.user?.email) {
        fetchUserInfo();
      }
    }, [session]);
    
    const fetchUserInfo = async () => {
      try {
        const res = await fetch('/api/user/profile');
        const data = await res.json();
        setUserInfo(data.user);
      } catch (error) {
        console.error('Failed to fetch user info:', error);
      } finally {
        setLoading(false);
      }
    };
    
    return (
      <div className="max-w-2xl mx-auto p-6">
        <Card>
          <CardHeader>
            <CardTitle>내정보</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="font-semibold">이메일</label>
              <p>{userInfo?.email}</p>
            </div>
            <div>
              <label className="font-semibold">분석가능 횟수</label>
              <p>{userInfo?.analysis_count}회</p>
            </div>
            <div>
              <label className="font-semibold">플랜</label>
              <p>{userInfo?.plan === 'paid' ? '유료' : '무료'}</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  ```

### 4.2 프로필 API 엔드포인트 생성
- [ ] `src/app/api/user/profile/route.ts` 생성
  - GET: 로그인한 사용자의 정보 조회
  - 이메일, analysis_count, plan 반환
  
  ```typescript
  import { NextResponse } from 'next/server';
  import { getServerSession } from 'next-auth';
  import { authOptions } from '@/auth';
  import { getUserByEmail } from '@/lib/supabase/users';
  
  export async function GET() {
    try {
      const session = await getServerSession(authOptions);
      
      if (!session?.user?.email) {
        return NextResponse.json(
          { error: 'Unauthorized' },
          { status: 401 }
        );
      }
      
      const user = await getUserByEmail(session.user.email);
      
      if (!user) {
        return NextResponse.json(
          { error: 'User not found' },
          { status: 404 }
        );
      }
      
      return NextResponse.json({
        success: true,
        user: {
          email: user.email,
          name: user.name,
          analysis_count: user.analysis_count,
          plan: user.plan,
        },
      });
    } catch (error: any) {
      return NextResponse.json(
        { error: 'Failed to fetch user profile', details: error.message },
        { status: 500 }
      );
    }
  }
  ```

### 4.3 분석 횟수 차감 API 엔드포인트 생성
- [ ] `src/app/api/user/decrement-analysis/route.ts` 생성
  - POST: 분석 횟수 1 차감
  - 로그인 필요
  
  ```typescript
  import { NextResponse } from 'next/server';
  import { getServerSession } from 'next-auth';
  import { authOptions } from '@/auth';
  import { decrementAnalysisCount } from '@/lib/supabase/users';
  
  export async function POST() {
    try {
      const session = await getServerSession(authOptions);
      
      if (!session?.user?.email) {
        return NextResponse.json(
          { error: 'Unauthorized' },
          { status: 401 }
        );
      }
      
      const updatedUser = await decrementAnalysisCount(session.user.email);
      
      return NextResponse.json({
        success: true,
        analysis_count: updatedUser.analysis_count,
      });
    } catch (error: any) {
      return NextResponse.json(
        { error: 'Failed to decrement analysis count', details: error.message },
        { status: 500 }
      );
    }
  }
  ```

---

## 🎯 Phase 5: 통합 및 테스트

### 5.1 분석 페이지 완전 통합
- [ ] `src/app/analyze/page.tsx` 최종 수정
  - 분석 시작 전 횟수 확인
  - 로딩 UI 표시
  - 분석 성공 시 횟수 차감
  - 횟수 0일 때 에러 처리

### 5.2 네비게이션 테스트
- [ ] '내정보' 버튼 클릭 → 프로필 페이지 이동 확인
- [ ] 프로필 페이지에서 사용자 정보 올바르게 표시되는지 확인

### 5.3 분석 횟수 차감 테스트
- [ ] 분석 실행 → 횟수 차감 확인
- [ ] 프로필 페이지에서 차감된 횟수 확인
- [ ] 횟수 0일 때 분석 차단 확인

### 5.4 UI/UX 테스트
- [ ] 로딩 인디케이터 애니메이션 확인
- [ ] 메시지 가독성 확인
- [ ] 반응형 디자인 확인

---

## 🎯 Phase 6: 추가 개선사항 (선택사항)

### 6.1 분석 횟수 관리
- [ ] 관리자 기능: 특정 사용자 횟수 충전
- [ ] 횟수 구매 기능 추가
- [ ] 플랜 업그레이드 기능

### 6.2 알림 기능
- [ ] 횟수가 3회 이하일 때 경고 메시지
- [ ] 횟수가 0일 때 충전 안내 메시지

### 6.3 히스토리 기능
- [ ] 프로필 페이지에 최근 분석 이력 표시
- [ ] 총 분석 횟수 통계 표시

---

## 📝 데이터베이스 마이그레이션 스크립트

```sql
-- users 테이블 컬럼 추가 스크립트
-- Supabase SQL Editor에서 실행

-- 1. 컬럼 추가
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS analysis_count INTEGER DEFAULT 10,
ADD COLUMN IF NOT EXISTS plan VARCHAR(20) DEFAULT 'free' CHECK (plan IN ('free', 'paid'));

-- 2. 기존 사용자 데이터 업데이트 (모두 무료 플랜, 10회 제공)
UPDATE users 
SET analysis_count = 10, 
    plan = 'free' 
WHERE analysis_count IS NULL OR plan IS NULL;

-- 3. NOT NULL 제약조건 추가 (선택사항)
-- ALTER TABLE users 
-- ALTER COLUMN analysis_count SET NOT NULL,
-- ALTER COLUMN plan SET NOT NULL;

-- 4. 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_users_plan ON users(plan);
CREATE INDEX IF NOT EXISTS idx_users_analysis_count ON users(analysis_count);

-- 5. 코멘트 추가
COMMENT ON COLUMN users.analysis_count IS '남은 분석 가능 횟수';
COMMENT ON COLUMN users.plan IS '사용자 플랜 (free: 무료, paid: 유료)';

-- 6. 확인
SELECT email, analysis_count, plan FROM users LIMIT 10;
```

---

## ✅ 완료 기준

1. ✅ 분석 시작 시 로딩 인디케이터와 "최대 3분 소요" 메시지 표시
2. ✅ users 테이블에 `analysis_count`, `plan` 컬럼 추가
3. ✅ 우측 상단에 '내정보' 버튼 추가
4. ✅ '내정보' 페이지에서 이메일, 분석가능횟수, 플랜 표시
5. ✅ 분석 실행 시 횟수 차감 기능 동작
6. ✅ 횟수 0일 때 분석 차단 기능 동작
7. ✅ 모든 기능이 정상적으로 동작함을 테스트로 검증

---

## 📚 참고 자료
- [NextAuth.js Session Management](https://next-auth.js.org/getting-started/client#usesession)
- [Supabase SQL Functions](https://supabase.com/docs/guides/database/functions)
- [React Loading Spinners](https://tailwindcss.com/docs/animation)
