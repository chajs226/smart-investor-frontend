# TODO List - 2025년 10월 20일

## 📋 요구사항 요약
1. 소셜 로그인 성공 시 네이버/카카오에서 받은 이메일을 Supabase DB에 저장
2. 기업 분석 결과를 자동으로 Supabase DB에 저장

---

## 🎯 Phase 1: Supabase 사용자 테이블 설정 및 OAuth 연동

### 1.1 Supabase 데이터베이스 스키마 설계
- [ ] **users 테이블 생성**
  ```sql
  CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    provider VARCHAR(50) NOT NULL, -- 'naver' or 'kakao'
    provider_account_id VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(provider, provider_account_id)
  );
  
  CREATE INDEX idx_users_email ON users(email);
  CREATE INDEX idx_users_provider_account ON users(provider, provider_account_id);
  ```

### 1.2 Supabase 환경 변수 확인
- [ ] `.env.development`에 Supabase 환경변수 확인
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY` (서버 사이드용)

### 1.3 Supabase 클라이언트 유틸 함수 작성
- [ ] `src/lib/supabase/users.ts` 생성
  - `upsertUser()` - 사용자 정보 생성/업데이트
  - `getUserByEmail()` - 이메일로 사용자 조회
  - `updateLastLogin()` - 마지막 로그인 시간 업데이트

### 1.4 NextAuth signIn 콜백 수정
- [ ] `src/auth.ts`의 `signIn` 콜백 수정
  - OAuth 프로필에서 이메일 추출
  - Supabase에 사용자 정보 upsert
  - 에러 처리 및 로깅 추가
  
  ```typescript
  async signIn({ user, account, profile }: any) {
    try {
      // 이메일 추출 (네이버/카카오 프로필 구조 고려)
      const email = user.email || profile?.email || profile?.response?.email;
      
      if (email && account) {
        // Supabase에 사용자 정보 저장
        await upsertUser({
          email,
          provider: account.provider,
          provider_account_id: account.providerAccountId,
          name: user.name,
        });
      }
      
      return true;
    } catch (error) {
      console.error('Failed to save user to Supabase:', error);
      return false; // 로그인 실패 처리
    }
  }
  ```

### 1.5 JWT 토큰에 사용자 ID 추가
- [ ] `jwt` 콜백 수정하여 Supabase user ID를 토큰에 포함
- [ ] `session` 콜백 수정하여 세션에 user ID 노출

---

## 🎯 Phase 2: 기업 분석 결과 저장 기능 구현

### 2.1 Supabase 분석 결과 테이블 설계
- [ ] **stock_analyses 테이블 생성**
  ```sql
  CREATE TABLE stock_analyses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    market VARCHAR(20) NOT NULL, -- 'KOSPI', 'KOSDAQ', 'NASDAQ'
    symbol VARCHAR(20) NOT NULL, -- 주식 티커/코드
    name VARCHAR(100) NOT NULL, -- 기업명
    sector VARCHAR(100), -- 기업 섹터
    report TEXT NOT NULL, -- 분석 결과 리포트 (Markdown)
    financial_table TEXT, -- 재무제표 데이터
    compare_periods TEXT[], -- 비교 기간
    model VARCHAR(50), -- AI 모델명
    citations TEXT[], -- 참고 자료
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE INDEX idx_stock_analyses_user_id ON stock_analyses(user_id);
  CREATE INDEX idx_stock_analyses_symbol ON stock_analyses(symbol);
  CREATE INDEX idx_stock_analyses_market ON stock_analyses(market);
  CREATE INDEX idx_stock_analyses_created_at ON stock_analyses(created_at DESC);
  ```

### 2.2 Supabase 분석 결과 유틸 함수 작성
- [ ] `src/lib/supabase/analyses.ts` 생성
  - `saveAnalysis()` - 분석 결과 저장
  - `getAnalysesByUserId()` - 사용자별 분석 결과 조회
  - `getAnalysisBySymbol()` - 종목별 최신 분석 조회
  - `deleteAnalysis()` - 분석 결과 삭제

### 2.3 분석 페이지에 저장 기능 추가
- [ ] `src/app/analyze/page.tsx` 수정
  - 분석 완료 후 자동으로 Supabase에 저장
  - 세션에서 user ID 가져오기
  - 저장 성공/실패 알림 추가
  
  ```typescript
  // 분석 완료 후
  if (session?.user?.id) {
    await saveAnalysis({
      user_id: session.user.id,
      market: marketType, // KOSPI/KOSDAQ/NASDAQ
      symbol: stockCode,
      name: stockName,
      sector: sector,
      report: analysis.analysis,
      financial_table: analysis.financial_table,
      compare_periods: analysis.compare_periods,
      model: analysis.model,
      citations: analysis.citations,
    });
  }
  ```

### 2.4 분석 이력 조회 API 생성
- [ ] `src/app/api/analyses/route.ts` 생성
  - GET: 로그인한 사용자의 분석 이력 조회
  - POST: 새로운 분석 결과 저장 (백업용)

### 2.5 분석 이력 페이지 생성 (선택사항)
- [ ] `src/app/history/page.tsx` 생성
  - 사용자의 과거 분석 결과 목록 표시
  - 필터링 (시장별, 날짜별)
  - 상세 보기 기능

---

## 🎯 Phase 3: 테스트 및 검증

### 3.1 사용자 저장 테스트
- [ ] 네이버 로그인 → Supabase users 테이블에 데이터 저장 확인
- [ ] 카카오 로그인 → Supabase users 테이블에 데이터 저장 확인
- [ ] 중복 로그인 시 upsert 동작 확인
- [ ] last_login_at 업데이트 확인

### 3.2 분석 결과 저장 테스트
- [ ] 주식 분석 실행 → stock_analyses 테이블에 데이터 저장 확인
- [ ] 모든 필드가 올바르게 저장되는지 확인
- [ ] user_id 연결 확인
- [ ] 여러 번 분석 시 이력 누적 확인

### 3.3 에러 처리 테스트
- [ ] 네트워크 오류 시 에러 핸들링
- [ ] Supabase 연결 실패 시 처리
- [ ] 로그인하지 않은 상태에서 분석 시 처리

---

## 🎯 Phase 4: 보안 및 최적화

### 4.1 보안 설정
- [ ] Supabase RLS (Row Level Security) 정책 설정
  ```sql
  -- users 테이블 RLS
  ALTER TABLE users ENABLE ROW LEVEL SECURITY;
  
  CREATE POLICY "Users can view own data"
    ON users FOR SELECT
    USING (auth.uid() = id);
  
  -- stock_analyses 테이블 RLS
  ALTER TABLE stock_analyses ENABLE ROW LEVEL SECURITY;
  
  CREATE POLICY "Users can view own analyses"
    ON stock_analyses FOR SELECT
    USING (auth.uid() = user_id);
  
  CREATE POLICY "Users can insert own analyses"
    ON stock_analyses FOR INSERT
    WITH CHECK (auth.uid() = user_id);
  ```

### 4.2 성능 최적화
- [ ] 분석 결과 페이징 구현
- [ ] 인덱스 최적화 확인
- [ ] 불필요한 데이터 조회 최소화

### 4.3 모니터링
- [ ] 저장 성공/실패 로그 추가
- [ ] 에러 트래킹 설정

---

## 📝 추가 고려사항

### 데이터 정책
- [ ] 분석 결과 보관 기간 정책 결정 (예: 6개월, 1년)
- [ ] 사용자당 최대 저장 개수 제한 고려

### UI/UX 개선
- [ ] 저장 중 로딩 인디케이터 추가
- [ ] 저장 완료 토스트 알림
- [ ] 분석 이력 빠른 접근 버튼

### 향후 확장
- [ ] 분석 결과 공유 기능
- [ ] 분석 결과 비교 기능
- [ ] 즐겨찾기 종목 관리

---

## 🔧 필요한 패키지 설치 확인
```bash
# Supabase 클라이언트 (이미 설치되어 있을 가능성 높음)
npm install @supabase/supabase-js

# TypeScript 타입 정의 (선택사항)
npm install -D @supabase/supabase-js
```

---

## ✅ 완료 기준
1. ✅ 소셜 로그인 시 사용자 정보가 Supabase users 테이블에 자동 저장됨
2. ✅ 기업 분석 실행 시 결과가 stock_analyses 테이블에 자동 저장됨
3. ✅ 로그인한 사용자만 자신의 분석 결과를 조회할 수 있음
4. ✅ 에러 발생 시 적절한 에러 메시지 표시
5. ✅ 모든 기능이 정상적으로 동작함을 테스트로 검증

---

## 📚 참고 자료
- [NextAuth.js Documentation](https://next-auth.js.org/configuration/callbacks)
- [Supabase Documentation](https://supabase.com/docs)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/introduction)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
