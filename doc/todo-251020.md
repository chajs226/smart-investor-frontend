# TODO List - 2025ë…„ 10ì›” 20ì¼

## ğŸ“‹ ìš”êµ¬ì‚¬í•­ ìš”ì•½
1. ì†Œì…œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ë°›ì€ ì´ë©”ì¼ì„ Supabase DBì— ì €ì¥
2. ê¸°ì—… ë¶„ì„ ê²°ê³¼ë¥¼ ìë™ìœ¼ë¡œ Supabase DBì— ì €ì¥

---

## ğŸ¯ Phase 1: Supabase ì‚¬ìš©ì í…Œì´ë¸” ì„¤ì • ë° OAuth ì—°ë™

### 1.1 Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„
- [ ] **users í…Œì´ë¸” ìƒì„±**
  ```sql
  CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    provider VARCHAR(50) NOT NULL, -- 'naver' or 'kakao'
    provider_account_id VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(provider, provider_account_id)
  );
  
  CREATE INDEX idx_users_email ON users(email);
  CREATE INDEX idx_users_provider_account ON users(provider, provider_account_id);
  ```

### 1.2 Supabase í™˜ê²½ ë³€ìˆ˜ í™•ì¸
- [ ] `.env.development`ì— Supabase í™˜ê²½ë³€ìˆ˜ í™•ì¸
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY` (ì„œë²„ ì‚¬ì´ë“œìš©)

### 1.3 Supabase í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ í•¨ìˆ˜ ì‘ì„±
- [ ] `src/lib/supabase/users.ts` ìƒì„±
  - `upsertUser()` - ì‚¬ìš©ì ì •ë³´ ìƒì„±/ì—…ë°ì´íŠ¸
  - `getUserByEmail()` - ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ
  - `updateLastLogin()` - ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸

### 1.4 NextAuth signIn ì½œë°± ìˆ˜ì •
- [ ] `src/auth.ts`ì˜ `signIn` ì½œë°± ìˆ˜ì •
  - OAuth í”„ë¡œí•„ì—ì„œ ì´ë©”ì¼ ì¶”ì¶œ
  - Supabaseì— ì‚¬ìš©ì ì •ë³´ upsert
  - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€
  
  ```typescript
  async signIn({ user, account, profile }: any) {
    try {
      // ì´ë©”ì¼ ì¶”ì¶œ (ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ í”„ë¡œí•„ êµ¬ì¡° ê³ ë ¤)
      const email = user.email || profile?.email || profile?.response?.email;
      
      if (email && account) {
        // Supabaseì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
        await upsertUser({
          email,
          provider: account.provider,
          provider_account_id: account.providerAccountId,
          name: user.name,
        });
      }
      
      return true;
    } catch (error) {
      console.error('Failed to save user to Supabase:', error);
      return false; // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
    }
  }
  ```

### 1.5 JWT í† í°ì— ì‚¬ìš©ì ID ì¶”ê°€
- [ ] `jwt` ì½œë°± ìˆ˜ì •í•˜ì—¬ Supabase user IDë¥¼ í† í°ì— í¬í•¨
- [ ] `session` ì½œë°± ìˆ˜ì •í•˜ì—¬ ì„¸ì…˜ì— user ID ë…¸ì¶œ

---

## ğŸ¯ Phase 2: ê¸°ì—… ë¶„ì„ ê²°ê³¼ ì €ì¥ ê¸°ëŠ¥ êµ¬í˜„

### 2.1 Supabase ë¶„ì„ ê²°ê³¼ í…Œì´ë¸” ì„¤ê³„
- [ ] **stock_analyses í…Œì´ë¸” ìƒì„±**
  ```sql
  CREATE TABLE stock_analyses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    market VARCHAR(20) NOT NULL, -- 'KOSPI', 'KOSDAQ', 'NASDAQ'
    symbol VARCHAR(20) NOT NULL, -- ì£¼ì‹ í‹°ì»¤/ì½”ë“œ
    name VARCHAR(100) NOT NULL, -- ê¸°ì—…ëª…
    sector VARCHAR(100), -- ê¸°ì—… ì„¹í„°
    report TEXT NOT NULL, -- ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸ (Markdown)
    financial_table TEXT, -- ì¬ë¬´ì œí‘œ ë°ì´í„°
    compare_periods TEXT[], -- ë¹„êµ ê¸°ê°„
    model VARCHAR(50), -- AI ëª¨ë¸ëª…
    citations TEXT[], -- ì°¸ê³  ìë£Œ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE INDEX idx_stock_analyses_user_id ON stock_analyses(user_id);
  CREATE INDEX idx_stock_analyses_symbol ON stock_analyses(symbol);
  CREATE INDEX idx_stock_analyses_market ON stock_analyses(market);
  CREATE INDEX idx_stock_analyses_created_at ON stock_analyses(created_at DESC);
  ```

### 2.2 Supabase ë¶„ì„ ê²°ê³¼ ìœ í‹¸ í•¨ìˆ˜ ì‘ì„±
- [ ] `src/lib/supabase/analyses.ts` ìƒì„±
  - `saveAnalysis()` - ë¶„ì„ ê²°ê³¼ ì €ì¥
  - `getAnalysesByUserId()` - ì‚¬ìš©ìë³„ ë¶„ì„ ê²°ê³¼ ì¡°íšŒ
  - `getAnalysisBySymbol()` - ì¢…ëª©ë³„ ìµœì‹  ë¶„ì„ ì¡°íšŒ
  - `deleteAnalysis()` - ë¶„ì„ ê²°ê³¼ ì‚­ì œ

### 2.3 ë¶„ì„ í˜ì´ì§€ì— ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€
- [ ] `src/app/analyze/page.tsx` ìˆ˜ì •
  - ë¶„ì„ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ Supabaseì— ì €ì¥
  - ì„¸ì…˜ì—ì„œ user ID ê°€ì ¸ì˜¤ê¸°
  - ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼ ì¶”ê°€
  
  ```typescript
  // ë¶„ì„ ì™„ë£Œ í›„
  if (session?.user?.id) {
    await saveAnalysis({
      user_id: session.user.id,
      market: marketType, // KOSPI/KOSDAQ/NASDAQ
      symbol: stockCode,
      name: stockName,
      sector: sector,
      report: analysis.analysis,
      financial_table: analysis.financial_table,
      compare_periods: analysis.compare_periods,
      model: analysis.model,
      citations: analysis.citations,
    });
  }
  ```

### 2.4 ë¶„ì„ ì´ë ¥ ì¡°íšŒ API ìƒì„±
- [ ] `src/app/api/analyses/route.ts` ìƒì„±
  - GET: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë¶„ì„ ì´ë ¥ ì¡°íšŒ
  - POST: ìƒˆë¡œìš´ ë¶„ì„ ê²°ê³¼ ì €ì¥ (ë°±ì—…ìš©)

### 2.5 ë¶„ì„ ì´ë ¥ í˜ì´ì§€ ìƒì„± (ì„ íƒì‚¬í•­)
- [ ] `src/app/history/page.tsx` ìƒì„±
  - ì‚¬ìš©ìì˜ ê³¼ê±° ë¶„ì„ ê²°ê³¼ ëª©ë¡ í‘œì‹œ
  - í•„í„°ë§ (ì‹œì¥ë³„, ë‚ ì§œë³„)
  - ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥

---

## ğŸ¯ Phase 3: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

### 3.1 ì‚¬ìš©ì ì €ì¥ í…ŒìŠ¤íŠ¸
- [ ] ë„¤ì´ë²„ ë¡œê·¸ì¸ â†’ Supabase users í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥ í™•ì¸
- [ ] ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ â†’ Supabase users í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥ í™•ì¸
- [ ] ì¤‘ë³µ ë¡œê·¸ì¸ ì‹œ upsert ë™ì‘ í™•ì¸
- [ ] last_login_at ì—…ë°ì´íŠ¸ í™•ì¸

### 3.2 ë¶„ì„ ê²°ê³¼ ì €ì¥ í…ŒìŠ¤íŠ¸
- [ ] ì£¼ì‹ ë¶„ì„ ì‹¤í–‰ â†’ stock_analyses í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥ í™•ì¸
- [ ] ëª¨ë“  í•„ë“œê°€ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸
- [ ] user_id ì—°ê²° í™•ì¸
- [ ] ì—¬ëŸ¬ ë²ˆ ë¶„ì„ ì‹œ ì´ë ¥ ëˆ„ì  í™•ì¸

### 3.3 ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- [ ] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì—ëŸ¬ í•¸ë“¤ë§
- [ ] Supabase ì—°ê²° ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
- [ ] ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ë¶„ì„ ì‹œ ì²˜ë¦¬

---

## ğŸ¯ Phase 4: ë³´ì•ˆ ë° ìµœì í™”

### 4.1 ë³´ì•ˆ ì„¤ì •
- [ ] Supabase RLS (Row Level Security) ì •ì±… ì„¤ì •
  ```sql
  -- users í…Œì´ë¸” RLS
  ALTER TABLE users ENABLE ROW LEVEL SECURITY;
  
  CREATE POLICY "Users can view own data"
    ON users FOR SELECT
    USING (auth.uid() = id);
  
  -- stock_analyses í…Œì´ë¸” RLS
  ALTER TABLE stock_analyses ENABLE ROW LEVEL SECURITY;
  
  CREATE POLICY "Users can view own analyses"
    ON stock_analyses FOR SELECT
    USING (auth.uid() = user_id);
  
  CREATE POLICY "Users can insert own analyses"
    ON stock_analyses FOR INSERT
    WITH CHECK (auth.uid() = user_id);
  ```

### 4.2 ì„±ëŠ¥ ìµœì í™”
- [ ] ë¶„ì„ ê²°ê³¼ í˜ì´ì§• êµ¬í˜„
- [ ] ì¸ë±ìŠ¤ ìµœì í™” í™•ì¸
- [ ] ë¶ˆí•„ìš”í•œ ë°ì´í„° ì¡°íšŒ ìµœì†Œí™”

### 4.3 ëª¨ë‹ˆí„°ë§
- [ ] ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸ ì¶”ê°€
- [ ] ì—ëŸ¬ íŠ¸ë˜í‚¹ ì„¤ì •

---

## ğŸ“ ì¶”ê°€ ê³ ë ¤ì‚¬í•­

### ë°ì´í„° ì •ì±…
- [ ] ë¶„ì„ ê²°ê³¼ ë³´ê´€ ê¸°ê°„ ì •ì±… ê²°ì • (ì˜ˆ: 6ê°œì›”, 1ë…„)
- [ ] ì‚¬ìš©ìë‹¹ ìµœëŒ€ ì €ì¥ ê°œìˆ˜ ì œí•œ ê³ ë ¤

### UI/UX ê°œì„ 
- [ ] ì €ì¥ ì¤‘ ë¡œë”© ì¸ë””ì¼€ì´í„° ì¶”ê°€
- [ ] ì €ì¥ ì™„ë£Œ í† ìŠ¤íŠ¸ ì•Œë¦¼
- [ ] ë¶„ì„ ì´ë ¥ ë¹ ë¥¸ ì ‘ê·¼ ë²„íŠ¼

### í–¥í›„ í™•ì¥
- [ ] ë¶„ì„ ê²°ê³¼ ê³µìœ  ê¸°ëŠ¥
- [ ] ë¶„ì„ ê²°ê³¼ ë¹„êµ ê¸°ëŠ¥
- [ ] ì¦ê²¨ì°¾ê¸° ì¢…ëª© ê´€ë¦¬

---

## ğŸ”§ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
```bash
# Supabase í´ë¼ì´ì–¸íŠ¸ (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ)
npm install @supabase/supabase-js

# TypeScript íƒ€ì… ì •ì˜ (ì„ íƒì‚¬í•­)
npm install -D @supabase/supabase-js
```

---

## âœ… ì™„ë£Œ ê¸°ì¤€
1. âœ… ì†Œì…œ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ì •ë³´ê°€ Supabase users í…Œì´ë¸”ì— ìë™ ì €ì¥ë¨
2. âœ… ê¸°ì—… ë¶„ì„ ì‹¤í–‰ ì‹œ ê²°ê³¼ê°€ stock_analyses í…Œì´ë¸”ì— ìë™ ì €ì¥ë¨
3. âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŒ
4. âœ… ì—ëŸ¬ ë°œìƒ ì‹œ ì ì ˆí•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
5. âœ… ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•¨ì„ í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦

---

## ğŸ“š ì°¸ê³  ìë£Œ
- [NextAuth.js Documentation](https://next-auth.js.org/configuration/callbacks)
- [Supabase Documentation](https://supabase.com/docs)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/introduction)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
