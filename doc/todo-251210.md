# TODO: 회원탈퇴 기능 구현 (2025-12-10)

## 요구사항
- 내정보 화면 가장 하단에 회원 탈퇴 버튼 추가
- '회원 탈퇴 시, 기존의 조회 기록은 삭제 됩니다' 안내 메시지 보여주고, 최종 확인 시 삭제 처리
- 회원 탈퇴시 users 데이터 삭제 처리

## 작업 리스트

### 1. Backend: 회원 탈퇴 함수 추가 ✅
**파일**: `/src/lib/supabase/users.ts`

- [x] `deleteUser(userId: string)` 함수 구현
  - users 테이블에서 사용자 삭제
  - user_providers 테이블은 ON DELETE CASCADE로 자동 삭제됨
  - analyses_history 테이블 데이터도 함께 삭제 (CASCADE 확인 필요)
  - 삭제 전 존재 여부 확인
  - 트랜잭션 처리 고려

### 2. API Route 생성: DELETE /api/user/account ✅
**파일**: `/src/app/api/user/account/route.ts` (신규 생성)

- [x] DELETE 메서드 구현
  - NextAuth session으로 현재 사용자 확인
  - 사용자 ID 추출
  - `deleteUser()` 함수 호출
  - 성공 시 200 응답
  - 실패 시 적절한 에러 메시지와 상태 코드 반환

### 3. Frontend: 회원 탈퇴 UI 컴포넌트 추가 ✅
**파일**: `/src/app/profile/page.tsx`

- [x] 프로필 페이지 하단에 회원 탈퇴 섹션 추가
  - Card 컴포넌트로 구분된 영역
  - 제목: "회원 탈퇴"
  - 경고 아이콘 및 텍스트
  - 탈퇴 버튼 (빨간색, 위험 스타일)

- [x] 1차 확인 다이얼로그 구현
  - 버튼 클릭 시 모달/다이얼로그 표시
  - 안내 메시지: "회원 탈퇴 시, 기존의 조회 기록은 삭제 됩니다"
  - 추가 안내:
    - "탈퇴 후에는 복구할 수 없습니다"
    - "남은 분석 횟수: X회가 모두 소멸됩니다"
    - "연동된 소셜 계정 정보도 모두 삭제됩니다"
  - 취소 버튼
  - 계속 진행 버튼

- [x] 2차 최종 확인 다이얼로그 구현
  - 1차 확인 후 추가 확인 단계
  - "정말로 탈퇴하시겠습니까?" 메시지
  - ~~텍스트 입력으로 "탈퇴" 또는 "DELETE" 입력 요구 (선택사항)~~ (생략)
  - 취소 버튼
  - 탈퇴 확정 버튼

- [x] API 호출 및 처리
  - DELETE /api/user/account 호출
  - 로딩 상태 표시
  - 성공 시:
    - NextAuth signOut() 호출
    - 성공 메시지 alert
    - 메인 페이지로 리다이렉트
  - 실패 시:
    - 에러 메시지 표시
    - 다이얼로그 닫지 않음

### 4. Database: Cascade 삭제 설정 확인 ✅
**파일**: Supabase Schema v2 (이미 설정됨)

- [x] users 테이블의 ON DELETE CASCADE 확인
  - user_providers 테이블: user_id FK ✅
  - analyses_history 테이블: user_id FK ✅
  
- [x] ~~필요시 마이그레이션 스크립트 작성~~ (이미 설정되어 있음)

### 5. UI/UX 컴포넌트 활용 ✅
**파일들**: 기존 UI 컴포넌트 재사용

- [x] AlertDialog 컴포넌트 생성
  - `/src/components/ui/alert-dialog.tsx` (신규 생성)
  - `@radix-ui/react-alert-dialog` 패키지 설치

- [x] Button 컴포넌트 variant 활용
  - destructive variant (빨간색 위험 버튼)

- [x] Icons 추가
  - lucide-react의 AlertTriangle, Trash2 사용

### 6. 테스트 시나리오 🔄
- [ ] 테스트 계정 생성 후 탈퇴 흐름 테스트
  - 1차 확인 다이얼로그 표시 확인
  - 취소 동작 확인
  - 2차 확인 다이얼로그 표시 확인
  - 최종 탈퇴 처리 확인
  - DB에서 실제 삭제 확인
  - 연관 데이터 삭제 확인 (user_providers, analyses_history)
  - 로그아웃 및 리다이렉션 확인

- [ ] 에러 케이스 테스트
  - 세션 없이 API 호출 시
  - 이미 삭제된 사용자 재삭제 시
  - 네트워크 에러 시

### 7. 문서화 ✅
- [x] 구현 완료 후 문서 작성
  - implementation-summary-251210.md 생성
  - 회원 탈퇴 기능 설명
  - 삭제되는 데이터 목록
  - 복구 불가능 안내

## 우선순위
1. Database Cascade 설정 확인 (가장 중요)
2. Backend 함수 구현 (deleteUser)
3. API Route 생성
4. Frontend UI 구현
5. 테스트 및 문서화

## 예상 소요 시간
- Database 작업: 30분
- Backend 함수: 30분
- API Route: 30분
- Frontend UI: 2시간
- 테스트: 1시간
- **총 예상 시간**: 약 4.5시간

## 주의사항
- ⚠️ CASCADE 삭제 설정이 올바르지 않으면 orphan 데이터가 남을 수 있음
- ⚠️ 실수로 탈퇴하는 것을 방지하기 위해 최소 2단계 확인 필요
- ⚠️ 탈퇴 후 즉시 로그아웃 처리 필수
- ⚠️ 관련된 모든 데이터 삭제 확인 (개인정보보호법 준수)
