## TODOs — 2025-10-18 (로그인 최소화 + Supabase 저장/조회)

### 범위
- **목표**: 사용자 정보 수집 최소화의 회원가입/로그인(카카오/네이버 OAuth2)과 백엔드 분석결과를 Supabase DB에 자동 저장. 저장된 리포트를 프론트엔드에서 조회 가능하게 구현.
- **연관 리포지토리**: 프론트엔드(현재 프로젝트), 백엔드(`../../smart-investor-backend`).

---

### 결정/설계 선행 작업
- [x] 인증 아키텍처 결정: (선택) NextAuth.js(Kakao/Naver) + 서버 전용 Supabase 접근
  - 사유: Supabase의 Custom OAuth 설정 없이 Kakao/Naver를 바로 사용 가능, 세션은 JWT로 간단 운용, DB 접근은 서버 라우트에서 서비스 키로 단순화. RLS 종속 제거(서버단 인증으로 차단)로 초기 복잡도↓.
  - 접근: FE는 NextAuth로 로그인/로그아웃 및 세션 유지. 데이터 접근은 Next.js Route Handler에서 세션 검사 후 Supabase 서비스 키로 DB 접근.
  - 보안: 서비스 키는 서버 전용 환경변수로만 사용. 브라우저에 노출 금지.
- [x] 리포트 저장 포맷 결정: `JSONB` 권장 (구조적 질의/정렬에 유리, Markdown은 필요 시 렌더용 필드 추가 고려)

---

### 환경 변수/시크릿 준비
# - [ ] Supabase: `SUPABASE_URL`, `SUPABASE_ANON_KEY` (FE), `SUPABASE_SERVICE_ROLE_KEY`(BE)
# - [ ] OAuth: `KAKAO_CLIENT_ID`, `KAKAO_CLIENT_SECRET`, `NAVER_CLIENT_ID`, `NAVER_CLIENT_SECRET`, 각 리다이렉트 URL 등록
# - [ ] `.env.example` 작성/업데이트 (FE/BE 각각)

---

### 데이터베이스(Supabase) 스키마 및 보안
# - [ ] 테이블 `reports` 생성 (Postgres)
#   - 컬럼
#    - `id` UUID PK (default gen_random_uuid())
#    - `user_id` UUID (작성자; nullable 허용 여부 결정)
#    - `market` TEXT (예: `KOSPI`/`KOSDAQ`/`NASDAQ` 등) — 필요시 CHECK 제약 또는 enum
#    - `symbol` TEXT (티커/코드)
#    - `name` TEXT (기업명)
#    - `sector` TEXT (섹터명)
#    - `report` JSONB 또는 TEXT (분석 결과)
#    - `created_at` TIMESTAMPTZ (default now())
#  - [ ] 인덱스: `(user_id)`, `(created_at DESC)`, `(market, symbol)`
# - [ ] RLS 정책 활성화 및 정책 작성
#  - [ ] 인증 사용자: 자신의 `user_id` 행만 `select/insert/update/delete`
#  - [ ] 비인증 사용자: 접근 불가
#  - [ ] 서비스 롤키(BE)로 서버에서 삽입 허용 정책 점검
# - [ ] 마이그레이션 SQL 작성(가능하면 Supabase CLI 사용) 및 공유

---

### 프론트엔드 (현 리포지토리)
- [ ] Supabase 클라이언트 초기화 유틸 추가 (키/URL는 환경변수 참조)
- [ ] 로그인/로그아웃 UI (헤더 버튼, 상태 표시)
- [ ] 세션 상태 관리: 로딩/인증됨/비인증 상태 처리
- [ ] 리포트 리스트 페이지
  - [ ] 페이지네이션 또는 무한스크롤
  - [ ] 필터(시장 `market`), 검색(`symbol`/`name`)
  - [ ] 빈 상태/로딩/에러 UI
- [ ] 리포트 상세 페이지
  - [ ] `report` 렌더링 방식 적용(JSON → 포맷팅 or Markdown 렌더)
  - [ ] 공유 가능한 URL 구조 설계
- [ ] 데이터 호출 경로 결정
  - [ ] (옵션1) RLS 기반 브라우저 직접 쿼리
  - [ ] (옵션2) Next.js 서버 액션/Route Handler 경유
- [ ] 기본 접근성/반응형/다크모드 스타일 점검
- [ ] E2E/통합 테스트(주요 플로우: 로그인 → 리스트 → 상세)

---

### 백엔드 (`../../smart-investor-backend`)
- [ ] Supabase Python 클라이언트 도입(`supabase`/`postgrest` 등) 및 `requirements.txt` 업데이트
- [ ] 서비스 함수 구현: `save_analysis_report(market, symbol, name, sector, report, user_id?)`
  - [ ] 유효성 검사 및 예외 처리(네트워크/제약 오류 재시도 전략 포함)
  - [ ] 로깅(민감정보 마스킹)
- [ ] 분석 파이프라인에 저장 단계 연결
  - [ ] 리포트 생성 시 자동 저장
  - [ ] 실패 시 재시도/보류 큐 설계(필요 시)
- [ ] 단위/통합 테스트: 삽입 성공/실패, 경계값, 대용량 report 처리
- [ ] 간단한 조회 API(선택): 사용자별/심볼별/마켓별 리스트 제공 (FE 서버 경유 시)

---

### 문서화/운영
- [ ] README 업데이트(설치/실행, OAuth 앱 설정 방법, 리다이렉트 URL)
- [ ] API 문서 업데이트(리포트 스키마, 필드 설명)
- [ ] 보안 가이드: 최소 정보 수집 원칙(프로필 미수집, provider UID만 보관 등) 명시
- [ ] 배포 체크리스트: 환경변수, RLS 정책, 마이그레이션 적용 순서

---

### 수용 기준(AC)
- [ ] 카카오/네이버를 통한 로그인/로그아웃이 동작하고, FE에서 세션 상태가 반영된다.
- [ ] 백엔드는 리포트 생성 시 Supabase `reports` 테이블에 자동 저장한다.
- [ ] FE에서 저장된 리포트를 마켓/검색으로 탐색하고 상세를 열람할 수 있다.
- [ ] 비인증 사용자는 데이터 접근이 차단된다(RLS 동작 확인).
- [ ] 환경변수와 문서가 정리되어 신규 개발자가 30분 내 로컬 구동 가능하다.


