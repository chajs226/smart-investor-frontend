# TODO 리스트 - 251128

## 요구사항 분석
1. 캐시 데이터 조회 시에도 사용자에게 안내 메시지 표시하지 않기 + 분석 횟수는 항상 차감
2. 분석 가능 횟수가 0일 때 '분석가능횟수 충전' 버튼 표시
3. 충전 버튼 클릭 시 충전 페이지로 이동
4. 충전 페이지: 20회(500원), 50회(1000원) 플랜 구성
5. 토스 페이먼츠 결제 연동

---

## 작업 리스트

### 1. 캐시 로직 수정
- [x] **파일**: `src/app/analyze/page.tsx`
  - [x] 캐시 조회 성공 시 토스트 메시지 제거 (line 118: `setToast('✅ 기존 분석 결과를 불러왔습니다 (캐시)');`)
  - [x] 캐시 히트 시에도 분석 횟수 차감 로직 추가 (캐시 반환 후 `/api/user/decrement-analysis` 호출)
  - [x] 캐시 조회 전에 분석 횟수 확인 로직 제거 (line 95-104)

- [x] **파일**: `src/app/api/analyses/check-cache/route.ts`
  - [x] 이력 저장은 유지하되, 클라이언트에서 횟수 차감하도록 로직 조정
  - [x] (선택) 로깅 메시지 정리

---

### 2. Profile 페이지 - 충전 버튼 추가
- [x] **파일**: `src/app/profile/page.tsx`
  - [x] `analysis_count === 0` 조건 추가
  - [x] "분석가능 횟수" 카드 내에 조건부 버튼 렌더링
  - [x] 버튼 클릭 시 `/recharge` 페이지로 라우팅
  - [x] 버튼 UI: 파란색 계열, "분석가능횟수 충전" 텍스트

---

### 3. Recharge 페이지 생성
- [x] **파일**: `src/app/recharge/page.tsx` (신규 생성)
  - [x] 페이지 레이아웃 구성
  - [x] 충전 플랜 카드 2개 구성:
    - **플랜 1**: 20회 - 500원
    - **플랜 2**: 50회 - 1000원
  - [x] 각 플랜 선택 시 토스 페이먼츠 결제 페이지로 이동
  - [x] 토스 페이먼츠 위젯 초기화 로직 작성
  - [x] 결제 요청 시 필요한 정보: 금액(amount), 주문명(orderName), 주문 ID(orderId)

---

### 4. 토스 페이먼츠 연동 - 환경변수 설정
- [ ] **파일**: `.env.development`
  - [ ] `NEXT_PUBLIC_TOSS_CLIENT_KEY` 추가 (토스 페이먼츠 클라이언트 키)
  - [ ] `TOSS_SECRET_KEY` 추가 (서버 사이드 인증용 시크릿 키)

---

### 5. 토스 페이먼츠 SDK 설치
- [x] **터미널 명령어**:
  ```bash
  npm install @tosspayments/payment-widget-sdk
  ```
  또는
  ```bash
  npm install @tosspayments/tosspayments-sdk
  ```

---

### 6. 결제 성공/실패 콜백 페이지 생성
- [x] **파일**: `src/app/recharge/success/page.tsx` (신규 생성)
  - [x] 결제 성공 시 토스로부터 받은 쿼리 파라미터 파싱
  - [x] `/api/payment/confirm` API 호출하여 결제 승인 요청
  - [x] 성공 시 사용자 분석 횟수 증가
  - [x] 성공 메시지 표시 후 `/profile` 페이지로 리디렉션

- [x] **파일**: `src/app/recharge/fail/page.tsx` (신규 생성)
  - [x] 결제 실패 시 오류 메시지 표시
  - [x] "다시 시도" 버튼으로 `/recharge` 페이지로 돌아가기

---

### 7. 결제 승인 API 구현 (백엔드)
- [ ] **파일**: `src/app/api/payment/confirm/route.ts` (신규 생성)
  - [ ] 토스 페이먼츠 승인 API 호출
    - 엔드포인트: `POST https://api.tosspayments.com/v1/payments/confirm`
    - Authorization: `Basic Base64(SecretKey:)`
    - Body: `{ paymentKey, orderId, amount }`
  - [ ] 승인 성공 시 Supabase에 결제 이력 저장
  - [ ] 사용자의 `analysis_count` 증가 (20회 또는 50회)
  - [ ] 에러 처리 로직 추가

---

### 8. Supabase DB 스키마 수정
- [ ] **파일**: `doc/supabase-schema-payment.sql` (신규 생성)
  - [ ] `payments` 테이블 생성:
    ```sql
    CREATE TABLE payments (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      order_id TEXT NOT NULL UNIQUE,
      payment_key TEXT NOT NULL,
      amount INTEGER NOT NULL,
      plan_type TEXT NOT NULL, -- '20' or '50'
      status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'completed', 'failed'
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
    );
    
    CREATE INDEX idx_payments_user_id ON payments(user_id);
    CREATE INDEX idx_payments_order_id ON payments(order_id);
    ```
  - [ ] Supabase 콘솔에서 SQL 실행

---

### 9. Supabase Helper 함수 추가
- [ ] **파일**: `src/lib/supabase/payments.ts` (신규 생성)
  - [ ] `createPayment(userId, orderId, amount, planType)` - 결제 생성
  - [ ] `updatePaymentStatus(orderId, paymentKey, status)` - 결제 상태 업데이트
  - [ ] `getPaymentByOrderId(orderId)` - 주문 ID로 결제 조회

- [ ] **파일**: `src/lib/supabase/users.ts`
  - [ ] `incrementAnalysisCount(email, count)` - 분석 횟수 증가 함수 추가

---

### 10. 토스 페이먼츠 타입 정의
- [ ] **파일**: `src/types/payment.ts` (신규 생성)
  - [ ] Payment 인터페이스 정의
  - [ ] Plan 인터페이스 정의
  - [ ] TossPaymentConfirmRequest/Response 타입 정의

---

### 11. UI 컴포넌트 개선
- [ ] **파일**: `src/app/recharge/page.tsx`
  - [ ] 플랜 카드 디자인 (Card, CardHeader, CardTitle, CardContent 사용)
  - [ ] 선택된 플랜 강조 표시
  - [ ] 로딩 상태 처리
  - [ ] 결제 버튼 활성화/비활성화 로직

---

### 12. 에러 핸들링 및 로깅
- [ ] 모든 API 라우트에 try-catch 추가
- [ ] 클라이언트 사이드 에러 토스트 메시지 추가
- [ ] 결제 실패 시 사용자 친화적 메시지 표시

---

### 13. 테스트
- [ ] 캐시 히트 시 횟수 차감 동작 확인
- [ ] 분석 횟수 0일 때 충전 버튼 표시 확인
- [ ] 충전 페이지 UI 확인
- [ ] 토스 페이먼츠 테스트 결제 진행 (테스트 API 키 사용)
- [ ] 결제 성공 후 분석 횟수 증가 확인
- [ ] 결제 실패 시 에러 처리 확인

---

### 14. 문서화
- [ ] **파일**: `doc/payment-integration-guide.md` (신규 생성)
  - [ ] 토스 페이먼츠 연동 가이드
  - [ ] 환경변수 설정 방법
  - [ ] 테스트 카드 정보
  - [ ] 트러블슈팅 가이드

---

## 우선순위

### Phase 1 (필수 - 즉시 작업)
1. 캐시 로직 수정 (#1)
2. Profile 페이지 충전 버튼 추가 (#2)
3. Supabase DB 스키마 수정 (#8)
4. Supabase Helper 함수 추가 (#9)

### Phase 2 (핵심 기능)
5. Recharge 페이지 생성 (#3)
6. 토스 페이먼츠 SDK 설치 (#5)
7. 토스 페이먼츠 환경변수 설정 (#4)

### Phase 3 (결제 프로세스 완성)
8. 결제 승인 API 구현 (#7)
9. 결제 성공/실패 콜백 페이지 (#6)

### Phase 4 (완성도 향상)
10. 타입 정의 (#10)
11. UI 컴포넌트 개선 (#11)
12. 에러 핸들링 (#12)

### Phase 5 (검증 및 문서화)
13. 테스트 (#13)
14. 문서화 (#14)

---

## 참고 자료
- 토스 페이먼츠 공식 문서: https://docs.tosspayments.com/guides/v2/payment-widget/integration
- Next.js App Router 공식 문서: https://nextjs.org/docs/app
- Supabase 클라이언트 문서: https://supabase.com/docs/reference/javascript/introduction
