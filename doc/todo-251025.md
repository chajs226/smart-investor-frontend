# TODO List - 2025년 10월 25일

## 완료된 작업 ✅

### 1. 데이터베이스 구조
- [x] `analyses_history` 테이블 생성 마이그레이션 작성
  - user_id (users 테이블 참조)
  - analysis_id (stock_analyses 테이블 참조)
  - created_at, updated_at
  - 인덱스 및 RLS 정책 설정
  - 파일: `doc/supabase-migration-analyses-history.sql`

### 2. 백엔드 로직 구현
- [x] 분석 캐싱 함수 구현 (`getCachedAnalysis`)
  - 7일 이내 동일 조건 (market, symbol, name, compare_periods, model) 확인
  - 파일: `src/lib/supabase/analyses.ts`

- [x] 분석 이력 저장 함수 구현 (`saveAnalysisHistory`)
  - user_id와 analysis_id를 analyses_history에 저장
  - 파일: `src/lib/supabase/analyses.ts`

- [x] 사용자별 분석 이력 조회 함수 구현 (`getUserAnalysisHistory`)
  - stock_analyses 데이터 조인하여 반환
  - 파일: `src/lib/supabase/analyses.ts`

### 3. API 엔드포인트 구현
- [x] `POST /api/analyses/check-cache` - 캐시 확인 API
  - 분석 요청 전 캐시 체크
  - 캐시된 결과 있으면 바로 반환하고 이력 저장
  - 파일: `src/app/api/analyses/check-cache/route.ts`

- [x] `POST /api/analyses/save-history` - 이력 저장 API
  - 분석 완료 후 사용자 이력 저장 (로그인 필수)
  - 파일: `src/app/api/analyses/save-history/route.ts`

- [x] `GET /api/user/analyses-history` - 사용자 분석 이력 조회 API
  - 로그인한 사용자의 분석 이력 목록 반환
  - 파일: `src/app/api/user/analyses-history/route.ts`

- [x] `POST /api/analyses` 수정 - 캐싱 로직 적용
  - 캐시 확인 후 새로운 분석 저장
  - 로그인 사용자는 이력 자동 저장
  - 파일: `src/app/api/analyses/route.ts`

### 4. 프론트엔드 UI 구현
- [x] 분석 페이지 수정 (`src/app/analyze/page.tsx`)
  - 분석 요청 전 캐시 확인 로직 추가
  - 캐시된 결과 사용 시 토스트 메시지 표시
  - 새 분석 후 프론트엔드 Supabase에 저장 및 이력 기록

- [x] 내정보 페이지 수정 (`src/app/profile/page.tsx`)
  - 분석 이력 테이블 추가 (시장, 종목코드, 종목명, 분석일시, 리포트 버튼)
  - 리포트 보기 버튼 클릭 시 모달로 분석 결과 표시
  - 빈 상태 UI 처리

## 남은 작업 🔲

### 1. Supabase 마이그레이션 실행
- [ ] Supabase Dashboard에서 SQL Editor 열기
- [ ] `doc/supabase-migration-analyses-history.sql` 파일 내용 복사
- [ ] SQL Editor에서 실행하여 테이블 생성

### 2. 통합 테스트
- [ ] 로그인 후 분석 요청
- [ ] 동일 종목 재분석 시 캐시 작동 확인
- [ ] 내정보 페이지에서 분석 이력 확인
- [ ] 리포트 보기 버튼 클릭하여 상세 내용 확인

## 주요 변경사항 요약

### 데이터베이스
- `analyses_history` 테이블 생성 (users와 stock_analyses 연결)

### 기능 개선
1. **분석 캐싱**: 7일 이내 동일 조건 분석 재사용
2. **이력 추적**: 사용자별 분석 요청 기록
3. **내정보 확장**: 분석 이력 테이블 및 리포트 뷰어 추가

### 플로우
1. 사용자가 분석 요청
2. 프론트엔드에서 캐시 확인 API 호출
3. 캐시 있으면 → 바로 결과 반환 + 이력 저장
4. 캐시 없으면 → 백엔드 LLM 분석 → 프론트엔드 Supabase 저장 + 이력 저장
5. 내정보 페이지에서 이력 확인 가능

## 테스트 시나리오

1. **캐시 테스트**
   - 삼성전자 (005930) 분석 요청
   - 동일 조건으로 재분석 → "기존 분석 결과를 불러왔습니다 (캐시)" 토스트 확인

2. **이력 테스트**
   - 여러 종목 분석
   - 내정보 페이지에서 모든 분석 이력 표시 확인
   - 리포트 버튼 클릭하여 상세 내용 확인

3. **비로그인 테스트**
   - 로그아웃 상태에서 분석 가능
   - 이력은 저장되지 않음

## 주의사항

- Supabase 마이그레이션을 먼저 실행해야 이력 기능이 작동합니다
- 캐시는 7일간 유효하며, 같은 시장/종목/기간/모델 조건일 때만 적용됩니다
- 백엔드와 프론트엔드 모두 Supabase에 저장하지만, 중복 체크를 통해 한 번만 저장됩니다
